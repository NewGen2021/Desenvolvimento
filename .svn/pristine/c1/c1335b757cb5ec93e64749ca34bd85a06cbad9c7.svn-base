{% load hosts %}
{% load static %}
{% load i18n %}


<link href="{% static 'css/style2.css' %}" rel="stylesheet">

<link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.11.3/datatables.min.css"/>
<script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.10/jquery.mask.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.11.3/datatables.min.js"></script>

{% block content %}

<div class="table-responsive" style="margin: 40px;">
  <h3>Reservas do dia:</h3>
  <hr>
  <table class="table table-striped" id="tabela_listar" style="margin: auto;">
        <thead>
            <tr>
                <th>{% translate 'Cliente' %}</th>
                <th>{% translate 'Data' %}</th>
                <th>{% translate 'Hora' %}</th>
                <th>{% translate 'Espaço' %}</th>
                <th style="text-align: center;">{% translate 'Opções' %}</th>
            </tr>
        </thead>

        <tbody>
            {% for campo in object_list %}
            <tr id="campos">
                <td>{{ campo.id_cliente.nome }}</td>
                <td>{{ campo.data_reserva }}</td>
                <td>{{ campo.hora_entrada }}</td>
                <td>{{ campo.id_espaco }}</td>
                <td style="text-align: center;">
                  {% if campo.hora_entrada_real == None %}
                  <button type="button" class="btn btn-success btn-sm" id="btn_inicia{{campo.id_reserva}}" onclick="Inicia()">{% translate 'Validar Entrada' %}</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="btn_finaliza{{campo.id_reserva}}"  onclick="Finaliza()">{% translate 'Finalizar Reserva' %}</button>
                  {% else %}
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="btn_finaliza{{campo.id_reserva}}"  onclick="Finaliza()">{% translate 'Finalizar Reserva' %}</button>
                  {% endif %}
                </td>
                <script>
                  function Inicia(){
                      
                    fetch(`{{ domain }}/relatorios/api/valida_entrada/{{ campo.id_reserva }}?format=json`)
                      .then(function (content) {
                        return content.json()
                      
                      })
                      .then(function (data) {
                        var hora = data['hora_entrada_real']
                        var isValid = data['valido']
                        
                        var btn_inicia = document.getElementById("btn_inicia{{campo.id_reserva}}");
                       
                        
                        if(isValid){
                          alert("A reserva foi Iniciada!");
                          console.log("teste", isValid)
                          window.location.reload();
                        } else{
                          alert("Data ou hora invalida")
                        }
                      })
                   
                  }
                document.getElementById("btn_inicia{{campo.id_reserva}}").addEventListener("click", Inicia, false);

                function Finaliza() {
                  fetch(`{{ domain }}/relatorios/api/finaliza_reserva/{{ campo.id_reserva }}?format=json`)
                    .then(function (content) {
                      return content.json()
                    
                    })
                    .then(function (data) {
                      var hora = data['hora_saida_real']
                      var btn_finaliza = document.getElementById("btn_finaliza{{campo.id_reserva}}");

                      if(hora != null){
                        console.log('entrou');
                        alert("A reserva foi finalizada!");
                        document.getElementById('campos').style.display='none';
                      }
                    })
                }
              document.getElementById("btn_finaliza{{campo.id_reserva}}").addEventListener("click", Finaliza, false);


                  </script>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5">{% translate 'Nenhum campo registrado' %}</td>
            </tr>

            {% endfor %}
       </tbody>
    </table>
    <nav>
      <ul class="pagination justify-content-center" style="margin-top: 10px;">

          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number}}" style="margin-right:10px">{% translate 'Voltar' %}</a>
          {% endif %}
  
          <span>{{ page_obj.number}}</span>
         
  
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}" style="margin-left:10px">{% translate 'Próximo' %}</a>
  
          {% endif %}
  
      </ul>
    
  </nav>
</div>




{% endblock content %}


