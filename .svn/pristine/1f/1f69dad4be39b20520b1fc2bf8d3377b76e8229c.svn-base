{% extends base_template %}
{% load static %}
{% load i18n %}
{% load mathfilters %}
{% load hosts %}

{% block title %}{% translate "teste" %}{% endblock %}

{% block css %}

<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
<!-- CALENDAR CSS -->
<link href="{% static 'css/fullcalendar.css' %}" rel="stylesheet" />

<!-- COUNTER -->
<link rel="stylesheet" href="{% static 'css/counter.css' %}">

<style>

#calendar {
    max-width: 1100px;
    margin: 0 auto;
  }

    .blog .carousel-indicators {
	left: 0;
	top: auto;
    bottom: -40px;

}

/* The colour of the indicators */
.blog .carousel-indicators li {
    background: #a3a3a3;
    border-radius: 50%;
    width: 8px;
    height: 8px;
}

.blog .carousel-indicators .active {
background: #707070;
}
</style>
{% endblock css %}

{% block content %}
<section id="escolher_espaco" style='padding-top: 0.5%; padding-bottom: 0%; margin-top: 8%;'>
<div class="container">
    <div class="row">
        <button class="btn {{ button_color }}" type="button" data-toggle="collapse" data-target="#collapseEscolherSala"
            aria-expanded="true" aria-controls="collapseEscolherSala">
            {% translate "Escolher " %}{{tipo_espaco}}
        </button>
    </div>
    <div class="row blog">
        <div class="col-md-12">
            <hr style='margin-bottom: 7px;'>
            <div class="collapse" id="collapseEscolherSala">
                <div id="blogCarousel" class="carousel slide" data-ride="carousel">
    
                    <ol class="carousel-indicators">
                        {% for page in pages %}
                        <li data-target="#blogCarousel" data-slide-to="{{page.number|sub:1}}" {% if not page.has_previous %}
                            class="active" {% endif %}></li>
                        {% endfor %}
                    </ol>
    
                    <!-- Carousel items -->
                    <div class="carousel-inner" style="margin-bottom: 5%;">
    
                        {% for page in pages %}
                        <div class="carousel-item {% if not page.has_previous %} active {% endif %}">
                            <div class="row" style="justify-content: center;">
                                {% for espaco in page %}
                                <!-- <div class="col-md-{% if page.num_items == 3 %}4{% elif page.num_items == 2 %}6{% else %}12{% endif %}" -->
                                <div class="col-md-4">
                                    <a class='btn btn-outline-light btn-lg botao_escolher_espaco' role="button"
                                        onclick="selecionar(this)" id="espaco_{{espaco.id_espaco}}">
                                        <!-- style="max-height:15vw; max-width:15vw;" -->
                                        <img src="{{espaco.get_image_url}}" alt="Image" style="max-width:100%;">
                                            <!-- style="max-height:15vw; max-width:15vw;"> -->
                                        <br>
                                        <p>{% translate "Escolher" %}</p>
                                    </a>
                                    <div style="text-align: center;">
                                        <p>{{espaco}}</p>
                                        <p>{{espaco.get_preco}}</p>
                                        <p>{% translate "Capacidade: " %}{{espaco.vagas}} {% translate "pessoas" %}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <hr>
            </div>
    
        </div>
    </div>
</div>
</section>
<section id="agendar_sala" style='padding-top: 0.5%; padding-bottom: 0%;'>

    <div class="container align-items-center" style="text-align: center;">
        <div class="row">
            <button class="btn {{ button_color }}" type="button" data-toggle="collapse" data-target="#collapseEscolherHorario"
                aria-expanded="true" aria-controls="collapseEscolherHorario">
                {% translate "Escolher Horário" %}
            </button>
        </div>
    
        <div class="collapse" id="collapseEscolherHorario">
            <!--Inicio Calendário -->
            <div class="row">
                <div class="col-md-12" style='padding-top: 0.5%; padding-bottom: 0%; margin-bottom: 8%;'>
                    <p id='calendar_inner_text'>{% translate "Calendário não iniciado. Escolha um espaço primeiro." %}</p>
                    <div id="calendar">
                    </div>
                </div>
            </div>
            <!-- Fim Calendário -->
        
            <!--Inicio Modal -->
            <div class="modal fade show" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-primary">
                            <h5 class="modal-title text-white" id="exampleModalLongTitle">{% translate "Novo agendamento" %}
                            </h5>
                            <button id="modalClose1" type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form method="post">
                            {% csrf_token %}
                            <div class="modal-body">
                                <div class="form-group">
        
        
                                </div>
                                <!-- {% if compartilhado == 0 %}
                                  <div class="form-group">
                                      <label for="recipient-name" class="col-form-label">{% translate "Titulo do Evento:" %}</label>
                                      {{ form.id_espaco }}
                                  </div>
                                  {% endif %} -->
                                <div class="form-group">
                                    <div class="row d-flex align-items-center">
                                        <label for="message-text" class="col-form-label" style="font-size: 20px;">{% translate "Dia:" %}</label>
                                        <h1 class="col-form-label card-title" id="datepicker-data" style="font-size: 20px;">
                                        </h1>
                                        <input type="hidden" id="data-reserva" name="data-reserva" value="">
                                    </div>
                                    {% if compartilhado == 1 %}
                                    <div class="row d-flex align-items-center justify-content-center">
                                        <label for="quantity" class="col-form-label" style="font-size: 20px;">{% translate "Quantidade de reservas:" %}</label>
                                        <fieldset data-quantity>
                                            <legend>{% translate "Reservas" %}</legend>
                                        </fieldset>
                                        <script>

                                            // let contador = document.getElementsByTagName("quantity")[0][0];
                                            // let contador = $('[name="quantity"]')[0];
                                            // let fieldset = document.querySelectorAll('[data-quantity]');
                                            // fieldset.addEventListener("change", e => {
                                            //   let contador = $('[name="quantity"]')[0];
                                            //   console.log(contador.value);
                                            // });
                                            // alert(contador);
                                            function updater(quantity) {
                                                console.log(quantity);
                                                if (quantity instanceof Event)
                                                    var valor = quantity.target.value;
                                                else
                                                    var valor = quantity;
                                                console.log(valor);
                                            }
                                        </script>
                                    </div>
                                    {% endif %}
                                    <hr>
                                    <div class="row">
                                        <div class="form-group col-lg-6 ">
                                            <label for="message-text" class="col-form-label">{% translate "Hora de entrada:"%}</label>
                                            <!-- {{ form.hora_entrada }} -->
                                            <!-- <div id="datepicker-hora-entrada" value=""></div> -->
                                            <input type="time" id="hora-entrada" name="hora-entrada" value=""
                                                class="form-control timepicker">
                                        </div>
                                        <div class="form-group col-lg-6">
                                            <label for="message-text" class="col-form-label">{% translate "Hora de saída:"%}</label>
                                            <!-- {{ form.hora_saida }} -->
                                            <input type="time" id="hora-saida" name="hora-saida" value=""
                                                class="form-control timepicker">
                                            <!-- <div id="datepicker-hora-saida" value=""></div> -->
                                        </div>
                                        {% if hasErrors == True %}
                                        <script>
                                            alert("{{ error }}");
                                        </script>
                                        {% endif %}
        
                                    </div>
        
                                </div>
        
        
                            </div>
                            <div class="modal-footer">
                                <button id="modalClose2" type="button" class="btn btn-danger">{% translate "Fechar" %}</button>
                                <button id="modalClose3" type="submit" class="btn {{ button_color  }}">{% translate "Salvar"%}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fim Modal -->
    </div>
</section>
<section id="controle-dos-passos" style='padding-top: 0.5%; margin-bottom: 1%;'>
    <div class="container">
        <!-- <div class="row" style="margin-left: 7.5%; margin-top: 3%;"> -->
        <div class="row">
            <p class="card-text d-flex justify-content-left">{% translate "Passo 2 de 3"%}</p>
            <a href="{% host_url 'reserva' host 'custom_host' domain %}" class="btn btn-sm {{ button_color }} animate__animated animate__fadeInUp scrollto col-lg-2 col-md-6"> ← {% translate "VOLTAR" %} </a>
        </div>
    </div>
</section>


{% endblock content %}

{% block js %}

<!-- Contador -->
<script src="{% static 'js/counter.js' %}"></script>

<!-- Inicio Full Calendar Script -->
<script src="{% static 'js/fullcalendar.js' %}"></script>
<!-- <script>
    var calendar;
</script> -->
<script>
    let eventosDebug = [
        {
          title: 'All Day Event',
          start: '2020-09-01'
        },
        {
          title: 'Long Event',
          start: '2020-09-07',
          end: '2020-09-10'
        },
        {
          groupId: 999,
          title: 'Repeating Event',
          start: '2020-09-09T16:00:00'
        },
        {
          groupId: 999,
          title: 'Repeating Event',
          start: '2020-09-16T16:00:00'
        },
        {
          title: 'Conference',
          start: '2020-09-11',
          end: '2020-09-13',
          backgroundColor: 'black'
        },
        {
          title: 'Meeting',
          start: '2020-09-12T10:30:00',
          end: '2020-09-12T12:30:00'
        },
        {
          title: 'Lunch',
          start: '2020-09-12T12:00:00'
        },
        {
          title: 'Meeting',
          start: '2020-09-12T14:30:00'
        },
        {
          title: 'Happy Hour',
          start: '2020-09-12T17:30:00'
        },
        {
          title: 'Dinner',
          start: '2020-09-12T20:00:00'
        },
        {
          title: 'Birthday Party',
          start: '2020-09-13T07:00:00'
        },
        {
          title: 'Click for Google',
          url: 'http://google.com/',
          start: '2020-09-28'
        }
      ]

    function getMonthFromInfo(info) {
        var date = new Date(info.end);
        date.setMonth(date.getMonth() - 1);
        return `${date.getFullYear()}-${date.getMonth() + 1}`;
    }

    function hasClass(element, className) {
        return (' ' + element.className + ' ').indexOf(' ' + className + ' ') > -1;
    }

    function get_id_espaco() {
        selecionado = document.getElementsByClassName('botao_escolher_espaco active')[0];
        return selecionado.id.split('_')[1];
    }

    function criar_calendario () {
        var calendarEl = document.getElementById('calendar');
        try{
            calendarEl.destroy();
        } catch(e){}
        
        var today = new Date();
        today.setHours(0);
        today.setMinutes(0);
        today.setSeconds(0);

        // HORÁRIO COMERCIAL DO COWORKING
        businessHours = [{
            // days of week. an array of zero-based day of week integers (0=Sunday)
            daysOfWeek: [1, 2, 3, 4, 5], // Monday - Friday

            startTime: '07:00', // a start time (10am in this example)
            endTime: '22:00', // an end time (6pm in this example)
        },
        {
            daysOfWeek: [6, 0], // Saturday, Sunday

            startTime: '09:00', // a start time (10am in this example)
            endTime: '19:00', // an end time (6pm in this example)
        }]

        // CONFIGURAÇÕES DE MUDANÇA DE CADA VIEW
        changeToMonth = function (info) {
            calendar.changeView('dayGridMonth', info.dateStr);
            calendar.setOption('eventDisplay', 'background');
            calendar.setOption('selectable', 'false');
        }
        changeToWeek = function (info) {
            calendar.changeView('timeGridWeek', info.dateStr);
            calendar.setOption('eventDisplay', 'list-item');
            calendar.setOption('selectable', 'false');
        }
        changeToDay = function (info) {
            calendar.changeView('timeGridDay', info.dateStr);
            calendar.setOption('eventDisplay', 'list-item');
            calendar.setOption('selectable', 'true');
        }

    window.calendar = new FullCalendar.Calendar(calendarEl, {
      
      customButtons: {
        month: {
          text: 'Mês',
          click: changeToMonth,
          color: '#74b9ff'
        }, 
        week: {
          text: 'Semana',
          click: changeToWeek
        },
        day: {
          text: 'Dia',
          click: changeToDay
        }
      },
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        // right: 'dayGridMonth,timeGridWeek,timeGridDay'
        right: 'month,week,day'
      },
      allDaySlot: false,
      eventDisplay: 'background',
      eventColor: '#74b9ff',
      
      // initialDate: '2020-09-12',
      initialDate: today,
      navLinks: false, // can click day/week names to navigate views
      selectable: true,
      selectMirror: false,
      eventStartEditable: false,
      businessHours: businessHours,

      selectConstraint: "businessHours",
      // select: function(start, end) {
      //   alert(start, end);
      //   calendar.unselect();
      // },

      select: function(arg) {
          // $("[class=fc-non-business]").hide();
          // alert($("[class=fc-non-business]").length);
          // document.getElementById('calendar');
          // let unvalid_hours = document.getElementsByClassName("fc-non-business");
          // let final = false;
          // let tabelaDeHoras = document.getElementsByClassName("fc-timegrid-slots")[0].children[0].children[1].children;
          // for (var i = 0; i < unvalid_hours.length; i++) {
          //   element = unvalid_hours[i]
          //   h = element.clientHeight;
          //   horas = Math.round(h / 21.11);  // h / altura do elemento de uma meia hora
          //   if (!final){
          //     for (var j = 0; j < horas; j++) {
          //       // tabelaDeHoras[j].style.display = 'none';
          //       // tabelaDeHoras[j].parentNode.removeChild(tabelaDeHoras[j]);
          //       // tabelaDeHoras[j].children[0].style.display = 'none';
          //       // tabelaDeHoras[j].children[1].style.display = 'none';
          //       // console.log(tabelaDeHoras[j]);
          //     }
          //   }
          //   else{
          //     for (var j = tabelaDeHoras.length - horas; j < tabelaDeHoras.length; j++) {
          //       tabelaDeHoras[j].style.display = 'none';
          //       // console.log(tabelaDeHoras[j]);
          //     }
          //   }
          //   final = true;
          // }
          
          // console.log( document.getElementsByClassName("fc-timegrid-slots")[0].children[0].children[1] );
          // /* for (element in unvalid_hours){
          //   console.log(element);
          //   console.log(element.clientHeight);
          // } */
          // console.log(unvalid_hours);
          // console.log('ALOOOOOO3');
          // $("[class=fc-timegrid-bg-harness]").hide();
          // this.minTime = "14:00:00";
          function getTime(date){
            // const hour = date.getHours();
            // const minute = date.getMinutes();
            // const second = date.getSeconds();
            return date.toTimeString().split(" ")[0];
          }
          var modal = document.getElementById('eventModal')
          modal.style.display = 'block'
          const datepickerDate = document.getElementById('datepicker-data');
          dataReserva = `${arg.start.getDate()}/${(arg.start.getMonth()+1) < 10 ? '0' + (arg.start.getMonth()+1) : arg.start.getMonth()+1}/${arg.start.getFullYear()}`
          
          datepickerDate.textContent = dataReserva
          document.getElementById('data-reserva').value = dataReserva
          document.getElementById('hora-entrada').value = getTime(arg.start)
          document.getElementById('hora-saida').value = getTime(arg.end)
          calendar.unselect()
          
        },
/* 
      select: function(arg) {
        // var title = prompt('Event Title:');
        // if (title) {
        //   calendar.addEvent({
        //     title: title,
        //     start: arg.start,
        //     end: arg.end,
        //     allDay: arg.allDay
        //   })
        // }
        // calendar.unselect()
        
        
      }, */
      
      dateClick: function (info) {
        if (calendar.view.type == 'dayGridMonth') {
          if (!hasClass(info.dayEl, 'fc-day-past')) {
            calendar.changeView('timeGridDay', info.dateStr);
            calendar.setOption('eventDisplay', 'list-item');
            console.log(info);
            fetch(`/api/reserva_event/${info.dateStr}/{{cliente_id}}/1/?format=json`)
              .then(function (response) {
                return response.json()
              })
              .then(function (json) {
                if (json != {} && json.event_list != undefined){
                  // for(var event in json.event_list){
                  //   calendar.addEvent(event);
                  // }
                  json.event_list.forEach(evento => {
                    calendar.addEvent(evento)
                  });
                  // calendar.addEvent({
                  //   title: 'dynamic event',
                  //   start: "2021-10-29T13:00:00",
                  //   end: "2021-10-29T15:00:00",
                  //   color:"lightblue",
                  //   textColor:"black"
                  // });
                  
                }
                
                console.log("Aloooo");
                  // addEvent(json[0]);

                console.log(json);
                console.log("DATECLICK");
                    // document.getElementById(`id_preco`).value = json[0].preco;
                // preco_field.setAttribute('placeholder', json[0].preco);
              })
              .catch(function (e){
                console.log(e);
                alert('{% translate "Não foi possível ler as reservas do dia" %}');
              })
          }
          else{
            alert('{% translate "Este dia já passou." %}');
          }
          
          console.log(info);
        }
        else{
          // alert(`${info.date.getHours()}:${info.date.getMinutes() == 0 ? '00' : '30'}`);
        }
      },
      eventClick: function(calEvent) {
        // if (confirm('Are you sure you want to delete this event?')) {
        //   arg.event.remove()
        // }
        if (calendar.view.type == 'dayGridMonth') {
          
        }
        else{
          alert('{% translate "Este horário está reservado!" %}');
        }
        
      },
      viewRender: function (view, element) {
        console.log(view);
        console.log(element);
        },
      // editable: true,
      dayMaxEvents: true, // allow "more" link when too many events
      slotLabelFormat: {
        hour: '2-digit',
        minute: '2-digit',
        hour12:false,
      },
      // events: {{ eventos|safe }},
      eventSources: [

        // your event source
        // {
        //   url: 'http://{{domain}}/api/month_event/10/1/1/?format=json', // use the `url` property

        //   // color: 'yellow',    // an option!
        //   // textColor: 'black'  // an option!
        // },
        {
          events: function get_month_reservas(info, successCallback, failureCallback) {
            console.log(info);
            var mes = getMonthFromInfo(info);
            return fetch(`/api/month_event/${mes}/1/${get_id_espaco()}/?format=json`)
              .then(function (response) {
                return response.json()
              })
              .then(function (json) {
                return json;
              })
              .catch(function (e) {
                alert('{% translate "Não foi possível ler as reservas do dia" %}');
                failureCallback(e);
              })
            //   return {start: '2021-10-27T01:00:00', end: '2021-10-27T23:00:00', allDay: true,
            // color: 'yellow',    
            //     textColor: 'black'  }

          }

        }

        // any other sources...

      ],
      eventTimeFormat: { 
        hour: '2-digit',
        minute: '2-digit',
        hour12:false,
      }
      // events: eventosDebug
      

    });
        
        // window.calendar = new FullCalendar.Calendar(calendarEl, {
        //         initialView: 'dayGridMonth'
        //     });
        // var calendar = $('#calendar').fullCalendar({
        //     defaultDate: '2014-09-12',
        //     editable: true,
        //     eventLimit: true, // allow "more" link when too many events
        // });
        console.log("chegou2");
        $("#change_space").on('change', function () {
            alert("OPAAAAA");
            calendar.refetchEvents();
        });
        console.log("Chegou3");

        // let changer = document.getElementById("change_space");
        // changer.addEventListener('change', () => {
        //     alert("OPAAAAA");
        // });
        // calendarEl.aaaa = calendar();
        // console.log(calendarEl);
        // console.log(calendarEl.aaaa);
        // function bindToNode(node, name, fn) {
        // node[name] = fn.bind(node);
        // }
        // bindToNode(calendarEl, 'logValue', calendar.FullCalendar);

        window.calendar.render();
    };
    
    function ajustar_tamanho_calendario(){
        // var calendarEl = document.getElementById('calendar');
        // calendarEl.updateSize();
        calendar.updateSize();
    }

    const closeBtn1 = document.getElementById('modalClose1');
    const closeBtn2 = document.getElementById('modalClose2');
    const closeBtn3 = document.getElementById('modalClose3');
    closeBtn1.addEventListener('click', () => {
        const eventModal = document.getElementById('eventModal')
        eventModal.style.display = 'none';
    });
    closeBtn2.addEventListener('click', () => {
        const eventModal = document.getElementById('eventModal')
        eventModal.style.display = 'none';
    });

    closeBtn3.addEventListener('click', () => {
        const eventModal = document.getElementById('eventModal')

        var datepickerOutput = myDatepicker1.toTimeString();
        var datepickerOutput2 = myDatepicker2.toTimeString();

        document.getElementById("hora-entrada").value = datepickerOutput;
        document.getElementById("hora-saida").value = datepickerOutput2;
    });
</script>


<script>
    function selecionar(botao){
        console.log(botao);
        if (document.getElementsByClassName('botao_escolher_espaco active')[0]){
            let botao_ativo = document.getElementsByClassName('botao_escolher_espaco active')[0];
            botao_ativo.classList.remove('active');
            botao_ativo.classList.add('btn-outline-light');
            botao_ativo.classList.remove('{{ button_color }}');
            botao_ativo.children[2].innerHTML = '{% translate "Escolher" %}'
        }
        botao.classList.add('active');
        botao.classList.remove('btn-outline-light');
        botao.classList.add('{{ button_color}}');
        botao.children[2].innerHTML = '{% translate "Escolhido" %}';
        $('#collapseEscolherHorario').collapse('show');
        document.getElementById('calendar_inner_text').innerText = '';
        criar_calendario();
    }

    $('#collapseEscolherHorario').on('shown.bs.collapse', function (e) {
        // try{
        //     $('#calendar').updateSize();
        // } catch(e){}
        // ajustar_tamanho_calendario();
        // $('#calendar').updateSize();
        // alert('Event fired on #' + e.currentTarget.id);
        window.calendar.updateSize();
    })
</script>
{% endblock js %}